
@if (isOpen()) {
  <div class="fixed inset-0 bg-black/50 dark:bg-black/70 flex items-center justify-center z-50 animate-fade-in" (click)="close()">
    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden" (click)="$event.stopPropagation()">
      
      <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
        <div>
          <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100">Editar Pedido</h2>
          <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">{{order().orderNumber}}</p>
        </div>
        <button (click)="close()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
        <div class="grid grid-cols-2 gap-4">
          
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Status</label>
            <select formControlName="status"
              class="w-full px-3 py-2 border rounded-lg dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100 focus:ring-2 focus:ring-blue-500">
              <option [value]="OrderStatus.Draft">Rascunho</option>
              <option [value]="OrderStatus.Pending">Pendente</option>
              <option [value]="OrderStatus.Confirmed">Confirmado</option>
              <option [value]="OrderStatus.InProgress">Em Andamento</option>
              <option [value]="OrderStatus.PartiallyFulfilled">Parcialmente Atendido</option>
              <option [value]="OrderStatus.Fulfilled">Atendido</option>
              <option [value]="OrderStatus.Shipped">Enviado</option>
              <option [value]="OrderStatus.Delivered">Entregue</option>
              <option [value]="OrderStatus.Cancelled">Cancelado</option>
              <option [value]="OrderStatus.OnHold">Em Espera</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Prioridade</label>
            <select formControlName="priority"
              class="w-full px-3 py-2 border rounded-lg dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100 focus:ring-2 focus:ring-blue-500">
              <option [value]="OrderPriority.Low">Baixa</option>
              <option [value]="OrderPriority.Normal">Normal</option>
              <option [value]="OrderPriority.High">Alta</option>
              <option [value]="OrderPriority.Urgent">Urgente</option>
            </select>
          </div>

          <div class="col-span-2">
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Data Esperada</label>
            <input type="date" formControlName="expectedDate"
              class="w-full px-3 py-2 border rounded-lg dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100 focus:ring-2 focus:ring-blue-500">
          </div>

          <div class="col-span-2">
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Endereço de Entrega</label>
            <input type="text" formControlName="shippingAddress" autocomplete="street-address"
              class="w-full px-3 py-2 border rounded-lg dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100 focus:ring-2 focus:ring-blue-500">
          </div>

          <div class="col-span-2">
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Instruções Especiais</label>
            <textarea formControlName="specialInstructions" rows="3"
              class="w-full px-3 py-2 border rounded-lg dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100 focus:ring-2 focus:ring-blue-500"></textarea>
          </div>

          <!-- WMS FIELDS -->
          <div class="col-span-2 mt-6 mb-2">
            <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-100 flex items-center gap-2">
              <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
              </svg>
              Logística WMS
            </h3>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Veículo</label>
            <button type="button" (click)="openVehicleSelector()"
              class="w-full px-3 py-2 border rounded-lg dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100 hover:bg-slate-50 dark:hover:bg-slate-700 focus:ring-2 focus:ring-blue-500 text-left flex items-center justify-between transition">
              @if (selectedVehicle()) {
                <span class="font-medium">{{selectedVehicle()?.licensePlate}} - {{selectedVehicle()?.model}}</span>
              } @else {
                <span class="text-slate-400">Selecionar veículo...</span>
              }
              <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </button>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Motorista</label>
            <button type="button" (click)="openDriverSelector()"
              class="w-full px-3 py-2 border rounded-lg dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100 hover:bg-slate-50 dark:hover:bg-slate-700 focus:ring-2 focus:ring-blue-500 text-left flex items-center justify-between transition">
              @if (selectedDriver()) {
                <span class="font-medium">{{selectedDriver()?.name}} - CNH: {{selectedDriver()?.licenseNumber}}</span>
              } @else {
                <span class="text-slate-400">Selecionar motorista...</span>
              }
              <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </button>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Armazém Origem</label>
            <button type="button" (click)="openOriginWarehouseSelector()"
              class="w-full px-3 py-2 border rounded-lg dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100 hover:bg-slate-50 dark:hover:bg-slate-700 focus:ring-2 focus:ring-blue-500 text-left flex items-center justify-between transition">
              @if (selectedOriginWarehouse()) {
                <span class="font-medium">{{selectedOriginWarehouse()?.code}} - {{selectedOriginWarehouse()?.name}}</span>
              } @else {
                <span class="text-slate-400">Selecionar armazém...</span>
              }
              <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </button>
          </div>

          <div class="col-span-2">
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Tipo de Destino</label>
            <div class="flex gap-4">
              <label class="flex items-center cursor-pointer">
                <input type="radio" name="destinationType" [value]="'customer'" (change)="setDestinationType('customer')" [checked]="destinationType() === 'customer'" class="mr-2">
                <span class="text-slate-700 dark:text-slate-300">Cliente</span>
              </label>
              <label class="flex items-center cursor-pointer">
                <input type="radio" name="destinationType" [value]="'warehouse'" (change)="setDestinationType('warehouse')" [checked]="destinationType() === 'warehouse'" class="mr-2">
                <span class="text-slate-700 dark:text-slate-300">Armazém (Transferência)</span>
              </label>
            </div>
          </div>

          @if (destinationType() === 'customer') {
            <div class="col-span-2">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Cliente Destino</label>
              <button type="button" (click)="openCustomerSelector()"
                class="w-full px-3 py-2 border rounded-lg dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100 hover:bg-slate-50 dark:hover:bg-slate-700 focus:ring-2 focus:ring-blue-500 text-left flex items-center justify-between transition">
                @if (selectedCustomer()) {
                  <span class="font-medium">{{selectedCustomer()?.name}} - {{selectedCustomer()?.document}}</span>
                } @else {
                  <span class="text-slate-400">Selecionar cliente...</span>
                }
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </button>
            </div>
          }

          @if (destinationType() === 'warehouse') {
            <div class="col-span-2">
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Armazém Destino</label>
              <button type="button" (click)="openDestinationWarehouseSelector()"
                class="w-full px-3 py-2 border rounded-lg dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100 hover:bg-slate-50 dark:hover:bg-slate-700 focus:ring-2 focus:ring-blue-500 text-left flex items-center justify-between transition">
                @if (selectedDestinationWarehouse()) {
                  <span class="font-medium">{{selectedDestinationWarehouse()?.code}} - {{selectedDestinationWarehouse()?.name}}</span>
                } @else {
                  <span class="text-slate-400">Selecionar armazém...</span>
                }
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </button>
            </div>
          }

          <!-- ROTA DE ENTREGA -->
          @if (selectedOriginWarehouse() && (selectedCustomer() || selectedDestinationWarehouse())) {
            <div class="col-span-2 mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-2 border-blue-200 dark:border-blue-800">
              <h3 class="text-lg font-bold text-blue-900 dark:text-blue-100 mb-4 flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                </svg>
                Rota de Entrega
              </h3>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- ORIGEM -->
                <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-300 dark:border-slate-600">
                  <div class="flex items-center gap-2 mb-3">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">A</div>
                    <h4 class="font-bold text-slate-800 dark:text-slate-100">ORIGEM</h4>
                  </div>
                  <div class="text-sm space-y-1">
                    <p class="font-semibold text-slate-900 dark:text-slate-100">{{selectedOriginWarehouse()?.name}}</p>
                    <p class="text-slate-600 dark:text-slate-400">Código: {{selectedOriginWarehouse()?.code}}</p>
                    @if (selectedOriginWarehouse()?.address) {
                      <p class="text-slate-700 dark:text-slate-300">{{selectedOriginWarehouse()?.address}}</p>
                    }
                    @if (selectedOriginWarehouse()?.city) {
                      <p class="text-slate-700 dark:text-slate-300">{{selectedOriginWarehouse()?.city}}, {{selectedOriginWarehouse()?.state}}</p>
                      <p class="text-slate-600 dark:text-slate-400">CEP: {{selectedOriginWarehouse()?.zipCode}}</p>
                      <p class="text-slate-600 dark:text-slate-400">{{selectedOriginWarehouse()?.country}}</p>
                    }
                  </div>
                </div>

                <!-- DESTINO -->
                <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-300 dark:border-slate-600">
                  <div class="flex items-center gap-2 mb-3">
                    <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white font-bold">B</div>
                    <h4 class="font-bold text-slate-800 dark:text-slate-100">DESTINO</h4>
                  </div>
                  
                  @if (selectedCustomer()) {
                    <div class="text-sm space-y-1">
                      <p class="font-semibold text-slate-900 dark:text-slate-100">{{selectedCustomer()?.name}}</p>
                      <p class="text-slate-600 dark:text-slate-400">{{selectedCustomer()?.document}}</p>
                      @if (selectedCustomer()?.address) {
                        <p class="text-slate-700 dark:text-slate-300">{{selectedCustomer()?.address}}</p>
                      }
                      @if (selectedCustomer()?.city) {
                        <p class="text-slate-700 dark:text-slate-300">{{selectedCustomer()?.city}}, {{selectedCustomer()?.state}}</p>
                        <p class="text-slate-600 dark:text-slate-400">CEP: {{selectedCustomer()?.zipCode}}</p>
                        <p class="text-slate-600 dark:text-slate-400">{{selectedCustomer()?.country}}</p>
                      }
                    </div>
                  }

                  @if (selectedDestinationWarehouse()) {
                    <div class="text-sm space-y-1">
                      <p class="font-semibold text-slate-900 dark:text-slate-100">{{selectedDestinationWarehouse()?.name}}</p>
                      <p class="text-slate-600 dark:text-slate-400">Código: {{selectedDestinationWarehouse()?.code}}</p>
                      @if (selectedDestinationWarehouse()?.address) {
                        <p class="text-slate-700 dark:text-slate-300">{{selectedDestinationWarehouse()?.address}}</p>
                      }
                      @if (selectedDestinationWarehouse()?.city) {
                        <p class="text-slate-700 dark:text-slate-300">{{selectedDestinationWarehouse()?.city}}, {{selectedDestinationWarehouse()?.state}}</p>
                        <p class="text-slate-600 dark:text-slate-400">CEP: {{selectedDestinationWarehouse()?.zipCode}}</p>
                        <p class="text-slate-600 dark:text-slate-400">{{selectedDestinationWarehouse()?.country}}</p>
                      }
                    </div>
                  }
                </div>
              </div>
            </div>
          }

          <div class="col-span-2 mt-6 mb-2">
            <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-100 flex items-center gap-2">
              <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
              Rastreamento
            </h3>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Código Rastreio</label>
            <input type="text" formControlName="trackingNumber" placeholder="BR123456789BR"
              class="w-full px-3 py-2 border rounded-lg dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100 focus:ring-2 focus:ring-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Entrega Estimada</label>
            <input type="date" formControlName="estimatedDeliveryDate"
              class="w-full px-3 py-2 border rounded-lg dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100 focus:ring-2 focus:ring-blue-500">
          </div>

        </div>
      </form>

      <div class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3">
        <button type="button" (click)="close()" [disabled]="loading()"
          class="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition">
          Cancelar
        </button>
        <button type="button" (click)="onSubmit()" [disabled]="loading()"
          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition disabled:opacity-50 flex items-center gap-2">
          @if (loading()) {
            <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
          }
          Salvar Alterações
        </button>
      </div>

    </div>
  </div>
}

<app-vehicle-selector-modal #vehicleModal (vehicleSelected)="onVehicleSelected($event)"></app-vehicle-selector-modal>

<app-driver-selector-modal #driverModal (driverSelected)="onDriverSelected($event)"></app-driver-selector-modal>

<app-warehouse-selector-modal #originModal [title]="'Selecionar Armazém de Origem'" (warehouseSelected)="onOriginWarehouseSelected($event)"></app-warehouse-selector-modal>

<app-warehouse-selector-modal #destModal [title]="'Selecionar Armazém de Destino'" (warehouseSelected)="onDestinationWarehouseSelected($event)"></app-warehouse-selector-modal>

<app-customer-selector-modal #customerModal (customerSelected)="onCustomerSelected($event)"></app-customer-selector-modal>
